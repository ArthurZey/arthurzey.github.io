{% if include.tags %}
  {% assign tags-to-iterate = include.tags | split: "," %}
{% elsif page.tags %}
  {% assign tags-to-iterate = page.tags %}
{% else %}
  {% assign tags-to-iterate = page.title | slugify %}
{% endif %}

{% capture tagged-docs-html-blob %}
  {% for tag-value in tags-to-iterate %}
    {% for page-to-consider in site.pages %}
      {% if page-to-consider.url != page.url and page-to-consider.tags contains tag-value %}
        {% if include.linkify-titles %}
### <a href="{{ page-to-consider.url }}">{{ page-to-consider.title }}</a>{% if include.suppress-stub-pill %}{% elsif page-to-consider.tags contains "stub" %} <sup>(stub/draft)</sup>{% endif %}
        {% else %}
### {{ page-to-consider.title }}{% if include.suppress-stub-pill %}{% elsif page-to-consider.tags contains "stub" %} <sup>(stub/draft)</sup>{% endif %}
        {% endif %}
{% if page-to-consider.tags contains "stub" %}{{ page-to-consider.content }}{% else %}{{ page-to-consider.description }}{% endif %}{% if include.edit-link %}&nbsp;&nbsp;<sub><a href="{{site.github.repository_url}}/edit/master/{{page-to-consider.path}}" target="_blank">Edit on GitHub</a>{% endif %}{% if include.linkify-titles == false %} &#124; <a href="{{ page-to-consider.url }}">{% if page-to-consider.date %}{{ page-to-consider.date }}{% else %}Permalink{% endif %}</a>{% endif %}</sub>
|
      {% endif %}
    {% endfor %}
    {% for post in site.tags[tag-value] %}
      {% if include.linkify-titles %}
### <a href="{{ post.url }}">{{ post.title }}</a>
      {% else %}
### {{ post.title }}
      {% endif %}
<i>{{ post.description }}</i>
|
    {% endfor %}
  {% endfor %}
{% endcapture %}

{% comment %}TO DO: SORT THE RESULTS!{% endcomment %}

{% assign tagged-docs-html-blob = tagged-docs-html-blob | strip %}
{% assign tagged-docs-array = tagged-docs-html-blob | split: '|' %}
{% if tagged-docs-array.size > 0 %}
  {% if include.heading %}
## {{ include.heading }}
  {% else %}
## Related Posts
  {% endif %}
  {% if include.description %}
_{{ include.description }}_
  {% endif %}
  {% for tagged-docs-html in tagged-docs-array %}
{{ tagged-docs-html }}
  {% endfor %}
{% endif %}
